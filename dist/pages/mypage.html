<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ - CTCã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</title>
    
    <!-- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« -->
    <style>
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f5; color: #333;}
        #app {min-height: 100vh; display: flex; flex-direction: column;}
        .home-container, .market-container, .mypage-container {padding: 16px 16px 70px; flex: 1; max-width: 800px; margin: 0 auto;}
        .bottom-nav {position: fixed; bottom: 0; left: 0; right: 0; background: #fff; display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000;}
        .nav-item {display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; font-size: 11px; padding: 4px;}
        .nav-item.active {color: #4a90e2;}
        .nav-icon {font-size: 18px; margin-bottom: 2px;}
        
        /* ãƒã‚¤ãƒšãƒ¼ã‚¸å›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .profile-section {background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .profile-header {display: flex; gap: 24px; align-items: center;}
        .profile-avatar {position: relative; width: 100px; height: 100px; border-radius: 50%; overflow: hidden; background: #f0f0f0;}
        .profile-avatar img {width: 100%; height: 100%; object-fit: cover; border-radius: 50%;}
        .profile-info {flex: 1;}
        .profile-name {font-size: 24px; font-weight: bold; margin-bottom: 4px; color: #333;}
        .profile-email {color: #666; font-size: 14px; margin-bottom: 12px;}
        .nft-section, .followed-channels-section, .history-section {background: white; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .section-title {font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #333;}
    </style>
    
    <!-- å¤–éƒ¨CSSãƒªãƒ³ã‚¯ -->
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="../styles/mypage.css">
    
    <!-- local-storage.jsã‚’ç›´æ¥ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚º -->
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒˆã‚¢ã®åˆæœŸåŒ–
        let storage = {
            user: null,
            profile: null,
            products: [],
            channels: [],
            transactions: [],
            nfts: []
        };

        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆæœŸåŒ–
        function initializeStorage() {
            if (typeof localStorage !== 'undefined') {
                if (!localStorage.getItem('ctc_storage')) {
                    localStorage.setItem('ctc_storage', JSON.stringify(storage));
                }
            }
        }

        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—
        async function getFromStorage(key) {
            if (typeof localStorage !== 'undefined') {
                const data = JSON.parse(localStorage.getItem('ctc_storage') || '{}');
                return data[key] || null;
            }
            return null;
        }

        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        async function saveToStorage(key, value) {
            if (typeof localStorage !== 'undefined') {
                const data = JSON.parse(localStorage.getItem('ctc_storage') || '{}');
                data[key] = value;
                localStorage.setItem('ctc_storage', JSON.stringify(data));
            }
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
        async function getUser() {
            const user = await getFromStorage('user');
            return { user };
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
        async function getUserProfile() {
            const profile = await getFromStorage('profile');
            return { profile };
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼NFTå–å¾—
        async function getUserNFTs() {
            const nfts = await getFromStorage('nfts');
            return { nfts: nfts || [] };
        }
        
        // å–å¼•å±¥æ­´å–å¾—
        async function getTransactions() {
            const transactions = await getFromStorage('transactions');
            return { transactions: transactions || [] };
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', initializeStorage);
    </script>
</head>
<body>
    <div id="app">
        <main class="mypage-container">
            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="profile-section">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img id="userAvatar" src="https://via.placeholder.com/100" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ">
                    </div>
                    <div class="profile-info">
                        <div class="profile-name-container">
                            <h2 id="userName" class="profile-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</h2>
                            <button class="edit-name-btn" id="editNameBtn">ç·¨é›†</button>
                        </div>
                        <p id="userEmail" class="profile-email">user@example.com</p>
                        <div class="profile-points">
                            <span class="points-icon">ğŸ†</span>
                            <span id="userPoints" class="points-value">0</span>
                            <span class="points-label">ãƒã‚¤ãƒ³ãƒˆ</span>
                        </div>
                    </div>
                </div>
                <div class="profile-actions">
                    <button id="connectWalletBtn" class="connect-metamask-btn">
                        <span class="metamask-icon">ğŸ¦Š</span>
                        MetaMaskæ¥ç¶š
                    </button>
                </div>
            </section>
            
            <!-- NFTã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="nft-section">
                <h2 class="section-title">æ‰€æœ‰NFT</h2>
                <div id="nftGrid" class="nft-grid">
                    <!-- NFTã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
                    <div class="no-data">æ‰€æœ‰ã—ã¦ã„ã‚‹NFTã¯ã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            </section>
            
            <!-- ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®ãƒãƒ£ãƒ³ãƒãƒ« -->
            <section class="followed-channels-section">
                <h2 class="section-title">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®ç”Ÿç”£è€…</h2>
                <div id="followedChannels" class="followed-channels">
                    <!-- ãƒãƒ£ãƒ³ãƒãƒ«ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
                    <div class="no-data">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®ç”Ÿç”£è€…ã¯ã„ã¾ã›ã‚“</div>
                </div>
            </section>
            
            <!-- å–å¼•å±¥æ­´ -->
            <section class="history-section">
                <h2 class="section-title">å–å¼•å±¥æ­´</h2>
                <div id="historyList" class="history-list">
                    <!-- å±¥æ­´ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
                    <div class="no-data">å–å¼•å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            </section>
        </main>

        <!-- ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="bottom-nav">
            <a href="/" class="nav-item">
                <i class="nav-icon">ğŸ </i>
                <span>ãƒ›ãƒ¼ãƒ </span>
            </a>
            <a href="/market" class="nav-item">
                <i class="nav-icon">ğŸ›ï¸</i>
                <span>ãƒãƒ¼ã‚±ãƒƒãƒˆ</span>
            </a>
            <a href="#" class="nav-item">
                <i class="nav-icon">ğŸ”§</i>
                <span>ãƒ„ãƒ¼ãƒ«</span>
            </a>
            <a href="/mypage" class="nav-item active">
                <i class="nav-icon">ğŸ‘¤</i>
                <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
            </a>
        </nav>
    </div>

    <!-- ãƒã‚¤ãƒšãƒ¼ã‚¸ã®ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯é–¢æ•°
        async function checkAuth() {
            const user = await getFromStorage('user');
            return user;
        }
        
        // åˆæœŸã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ãƒã‚§ãƒƒã‚¯
        async function checkAccess() {
            try {
                const user = await checkAuth();
                if (!user) {
                    const isProduction = !window.location.hostname.includes('localhost') && 
                                        !window.location.hostname.includes('127.0.0.1');
                    const authPath = isProduction ? '/auth' : '/src/pages/auth.html';
                    window.location.href = authPath;
                }
            } catch (error) {
                console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                const isProduction = !window.location.hostname.includes('localhost') && 
                                    !window.location.hostname.includes('127.0.0.1');
                const authPath = isProduction ? '/auth' : '/src/pages/auth.html';
                window.location.href = authPath;
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å‰ã«å®Ÿè¡Œ
        checkAccess();

        document.addEventListener('DOMContentLoaded', async function() {
            // ç’°å¢ƒåˆ¤å®š
            const isProduction = !window.location.hostname.includes('localhost') && 
                                !window.location.hostname.includes('127.0.0.1');
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã®ä¿®æ­£
            document.querySelectorAll('.nav-item').forEach(link => {
                const href = link.getAttribute('href');
                if (href === '/') return;
                
                if (!isProduction) {
                    // é–‹ç™ºç’°å¢ƒã§ã¯src/pagesä»¥ä¸‹ã‚’å‚ç…§
                    let pageName = href.startsWith('/') ? href.substring(1) : href;
                    pageName = pageName.replace('.html', '');
                    link.setAttribute('href', `/src/pages/${pageName}.html`);
                } else {
                    // æœ¬ç•ªç’°å¢ƒã§ã¯ãƒ«ãƒ¼ãƒˆã‚’å‚ç…§
                    let pageName = href.startsWith('/') ? href.substring(1) : href;
                    pageName = pageName.replace('.html', '');
                    link.setAttribute('href', `/${pageName}`);
                }
            });
            
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
                const { profile } = await getUserProfile() || { profile: null };
                if (profile) {
                    document.getElementById('userName').textContent = profile.username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å';
                    document.getElementById('userEmail').textContent = profile.email || 'user@example.com';
                    document.getElementById('userPoints').textContent = profile.points || '0';
                    
                    if (profile.avatar) {
                        document.getElementById('userAvatar').src = profile.avatar;
                    }
                }
                
                // NFTã‚’èª­ã¿è¾¼ã‚€
                const { nfts } = await getUserNFTs();
                const nftGrid = document.getElementById('nftGrid');
                
                if (nfts && nfts.length > 0) {
                    nftGrid.innerHTML = '';
                    nfts.forEach(nft => {
                        const nftCard = document.createElement('div');
                        nftCard.className = 'nft-card';
                        nftCard.innerHTML = `
                            <img src="${nft.image}" alt="${nft.name}" class="nft-image">
                            <div class="nft-info">
                                <h3 class="nft-name">${nft.name}</h3>
                                <p class="nft-date">å–å¾—æ—¥: ${new Date(nft.created_at).toLocaleDateString()}</p>
                                <p class="nft-price">${nft.price}å††</p>
                            </div>
                        `;
                        nftGrid.appendChild(nftCard);
                    });
                }
                
                // å–å¼•å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
                const { transactions } = await getTransactions();
                const historyList = document.getElementById('historyList');
                
                if (transactions && transactions.length > 0) {
                    historyList.innerHTML = '';
                    transactions.forEach(tx => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        historyItem.innerHTML = `
                            <div class="history-details">
                                <h3 class="history-title">${tx.title}</h3>
                                <p class="history-date">${new Date(tx.date).toLocaleDateString()}</p>
                            </div>
                            <p class="history-amount">${tx.amount}å††</p>
                        `;
                        historyList.appendChild(historyItem);
                    });
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                document.querySelector('.mypage-container').prepend(errorMsg);
            }
            
            // MetaMaskæ¥ç¶šãƒœã‚¿ãƒ³ã®å‡¦ç†
            document.getElementById('connectWalletBtn').addEventListener('click', async function() {
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        const address = accounts[0];
                        alert(`MetaMaskæ¥ç¶šæˆåŠŸ: ${address}`);
                        
                        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šæƒ…å ±ã‚’ä¿å­˜
                        const { profile } = await getUserProfile() || { profile: {} };
                        profile.wallet_address = address;
                        await saveToStorage('profile', profile);
                        
                        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                        this.disabled = true;
                        this.textContent = 'æ¥ç¶šæ¸ˆã¿: ' + address.substring(0, 6) + '...' + address.substring(address.length - 4);
                    } catch (error) {
                        console.error('MetaMaskæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                        alert('MetaMaskæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                } else {
                    alert('MetaMaskãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                }
            });
        });
    </script>
</body>
</html>